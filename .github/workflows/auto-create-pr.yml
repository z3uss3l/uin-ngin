name: Auto-create PR for feature branches

on:
  push:
    branches:
      - 'feature/**'

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Create PR via GitHub REST
        uses: actions/github-script@v6
        with:
          script: |
            const head = context.ref.replace('refs/heads/','');
            // Avoid creating a PR from a branch that already has one
            const pulls = await github.rest.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, head: `${context.repo.owner}:${head}`, state: 'open' });
            if (pulls.data.length > 0) {
              core.info(`PR already exists for ${head}: #${pulls.data[0].number}`);
            } else {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: head,
                base: 'main',
                title: `UI: polish & tests (${head})`,
                body: 'Automated PR created for UI polish and tests (includes unit tests and small refactors). CI will run and merge automatically when checks pass.'
              });
              core.info(`Created PR #${pr.data.number}`);
              // add label for automerge
              await github.rest.issues.addLabels({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.data.number, labels: ['automerge'] });
            }
